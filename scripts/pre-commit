#!/bin/bash

# get bash colors and styles here:
# http://misc.flogisoft.com/bash/tip_colors_and_formatting
C_RESET='\e[0m'
C_RED='\e[31m'
C_GREEN='\e[32m'
C_BROWN='\e[33m'
C_YELLOW='\e[93m'
C_GREY='\e[90m'

IS_MERGE=$(git rev-parse -q --verify MERGE_HEAD)
PRODUCTION_BRANCH="production"
LIVE_BRANCHES=("staging" "$PRODUCTION_BRANCH")
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

block_prohibit_merges() {
	local MERGED_BRANCH=$(git rev-parse --abbrev-ref HEAD@{upstream})
	local ALLOWED_BRANCH="master"
	if [[ "$PRODUCTION_BRANCH" == "$CURRENT_BRANCH" && "$MERGED_BRANCH" != "$ALLOWED_BRANCH" ]]; then
		echo "Error: Merging $MERGED_BRANCH directly into $CURRENT_BRANCH is not allowed. Please merge from $ALLOWED_BRANCH."
		exit 1
	fi
}

block_prohibit_commits() {
	for BRANCH in "${LIVE_BRANCHES[@]}"; do
		if [[ "$CURRENT_BRANCH" == "$BRANCH" ]]; then
			printf "${C_RED}\n"
			echo "Error: You are trying to commit directly to the $BRANCH branch."
			echo "Please commit your changes to a feature branch and then merge into the $BRANCH branch instead."
			printf "\n${C_RED}Aborting commit.${C_RESET}\n\n"
			exit 1
		fi
	done
}

printf "${C_GREEN}Pre-commit hook running...${C_RESET}\n\n"
if [[ -n "$IS_MERGE" ]]; then
	printf "\n[MERGE DETECTED] ... skipping code checks\n"
	block_prohibit_merges
	exit 0
fi

# Commits should not be made directly on Staging branch.
block_prohibit_commits

# Run code style checks on staged files

GIT_DIFF="git diff --cached --name-only --diff-filter=ACM"
STAGED_FILES=$(eval "$GIT_DIFF" | grep ".jsx\{0,1\}$")
PRETTIER="$(git rev-parse --show-toplevel)/node_modules/.bin/prettier"
ESLINT="$(git rev-parse --show-toplevel)/node_modules/.bin/eslint"

if [[ "$STAGED_FILES" = "" ]]; then
  printf "\e[92mNo files to check.\e[0m\nProceeding with commit..."
  exit 0
fi

PASS=true

# Enable nvm if available
if [ -f ~/.nvm/nvm.sh ]; then
  source ~/.nvm/nvm.sh
fi

# Check for prettier
if [[ ! -x "$PRETTIER" ]]; then
  printf "\e[31mPlease install dependencies first by running '\e[0m\e[1mnpm install\e[0m\e[31m'! (missing prettier)\e[0m\n"
  exit 1
fi

# Check for eslint
if [[ ! -x "$ESLINT" ]]; then
  printf "\e[31mPlease install dependencies first by running '\e[0m\e[1mnpm install\e[0m\e[31m'! (missing eslint)\e[0m\n"
  exit 1
fi

FILE_COUNT=$(echo "$STAGED_FILES" | wc -l)
FILES_ONE_LINE=$(echo -e ${STAGED_FILES/'\n'/' '});
SECONDS=0

printf "${C_YELLOW}$FILE_COUNT${C_RESET} staged file(s) will be checked for code styles.\n\n\e[31m"

# Run Prettier in check mode
"$PRETTIER" --check $FILES_ONE_LINE
if [[ "$?" != 0 ]]; then
  PASS=false
  printf "\nFile(s) above failed Prettier checks!"
fi

# Run ESLint using eslint.config.mjs
"$ESLINT" $FILES_ONE_LINE
if [[ "$?" != 0 ]]; then
  PASS=false
  printf "\nFile(s) above failed ESLint checks!"
fi

printf "\e[0m\n\n"

echo "Code style checks completed in $SECONDS seconds."

if ! $PASS; then
  printf "\n\e[31m\e[1mCOMMIT REJECTED.\e[0m \e[31mYour commit contains files that should pass code style checks but do not.\e[0m\n"
  printf "\nPlease fix code styles and try again. Running '\e[1mnpm run codestyles:fix:staged\e[0m' is a good start."
  printf "\nYou can run '\e[1mnpm run eslint\e[0m' to view ESLint code quality issues, if any.\n\n"
  exit 1
fi